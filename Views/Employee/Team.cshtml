@{
    ViewData["Title"] = "My Team";
}

<!-- Bootstrap & DataTables CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

<style>
    #employeeDetailCard {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1050;
        display: none;
        background: white;
        border-radius: 15px;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        padding: 20px;
        max-width: 600px;
        width: 90%;
    }

    #employeeDetailOverlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1040;
        display: none;
    }

    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        color: #333;
        cursor: pointer;
    }
</style>

<!-- Manager Profile -->
<div id="ManagerProfile" class="container mt-4">
    <h2 class="mb-4 text-center">Manager Profile</h2>
    <div class="row justify-content-center">
        <div class="card shadow-sm mb-4" style="max-width: 600px;">
            <div class="card-body d-flex flex-column align-items-center text-center">
                <img id="mgrImage" src="/image/default-avatar.PNG" alt="Manager Image" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;" />
                <h4 id="mgrName" class="card-title">Manager Name</h4>
                <p id="mgrEmail" class="text-muted">manager@example.com</p>
                <ul class="list-group list-group-flush w-100 text-start">
                    <li class="list-group-item"><strong>Role:</strong> <span id="mgrRole"></span></li>
                    <li class="list-group-item"><strong>Position:</strong> <span id="mgrPosition"></span></li>
                    <li class="list-group-item"><strong>Address:</strong> <span id="mgrAddress"></span></li>
                    <li class="list-group-item"><strong>Salary:</strong> <span id="mgrSalary"></span></li>
                    <li class="list-group-item"><strong>Manager ID:</strong> <span id="mgrManagerId"></span></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Manager Attendance -->
<div id="ManagerAttendence" class="container mb-5">
    <h3 class="text-center mb-4">Manager Attendance</h3>
    <table id="managerAttendanceTable" class="table table-bordered display nowrap" style="width:100%">
        <thead class="table-dark">
            <tr>
                <th>Date</th>
                <th>Attendance Type</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Team Table -->
<div id="TeamProfile" class="container mt-5">
    <h3 class="mb-3">Team Members</h3>
    <table id="teamTable" class="table table-bordered display nowrap" style="width:100%">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Team Attendance -->
<div id="teamAttendence" class="container mt-5">
    <h3 class="text-center mb-4">Team Attendance</h3>
    <table id="attendanceTable" class="table table-bordered display nowrap" style="width:100%">
        <thead class="table-dark">
            <tr>
                <th>Employee Name</th>
                <th>Date</th>
                <th>Attendance Type</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Overlay -->
<div id="employeeDetailOverlay"></div>

<!-- Employee Popup Card -->
<div id="employeeDetailCard" class="card shadow-sm">
    <span class="close-btn" id="closeDetailCard">&times;</span>
    <div class="card-body d-flex flex-column align-items-center text-center">
        <img id="empImage" src="/image/default-avatar.PNG" alt="Profile" class="rounded-circle mb-3" style="width: 100px; height: 100px; object-fit: cover;" />
        <h4 id="empName" class="card-title">Name</h4>
        <p id="empEmail" class="text-muted">email@example.com</p>
        <ul class="list-group list-group-flush w-100 text-start">
            <li class="list-group-item"><strong>Role:</strong> <span id="empRole"></span></li>
            <li class="list-group-item"><strong>Position:</strong> <span id="empPosition"></span></li>
            <li class="list-group-item"><strong>Address:</strong> <span id="empAddress"></span></li>
            <li class="list-group-item"><strong>Salary:</strong> <span id="empSalary"></span></li>
            <li class="list-group-item"><strong>Manager ID:</strong> <span id="empManagerId"></span></li>
        </ul>
    </div>
</div>

<!-- Scripts -->
@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>

        $(document).ready(function () {
            loadManagerDetails();
            loadTeam();

            $("#ManagerProfile, #ManagerAttendence, #TeamProfile, #teamAttendence").hide();
            $("#ManagerProfile").show();

            $('.dropdown-toggle').click(function () {
                const targetId = $(this).data('toggle');
                $('#' + targetId).slideToggle();
            });

            $(".sidebar a").click(function () {
                $(".sidebar a").removeClass("active");
                $(this).addClass("active");
            });

            $("#btnMyInfo").click(function () {
                $("#ManagerProfile").show();
                $("#ManagerAttendence, #TeamProfile, #teamAttendence").hide();
            });

            $("#btnMyAttendance").click(function () {
                $("#ManagerAttendence").show();
                $("#ManagerProfile, #TeamProfile, #teamAttendence").hide();
            });

            $("#btnMyTeam").click(function () {
                $("#TeamProfile").show();
                $("#ManagerProfile, #ManagerAttendence, #teamAttendence").hide();
            });

            $("#btnTeamAttendance").click(function () {
                $("#teamAttendence").show();
                $("#ManagerProfile, #ManagerAttendence, #TeamProfile").hide();
            });

            $('#closeDetailCard, #employeeDetailOverlay').click(function () {
                $('#employeeDetailCard').fadeOut();
                $('#employeeDetailOverlay').fadeOut();
            });
        });

        function loadManagerDetails() {
            $.ajax({
                url: '/Employee/GetTeamAttendance',
                method: 'GET',
                success: function (data) {
                    if (data.success && data.manager) {
                        const mgr = data.manager;

                        $('#mgrImage').attr('src', mgr.imagePath || '/image/default-avatar.PNG');
                        $('#mgrName').text(mgr.name);
                        $('#mgrEmail').text(mgr.email);
                        $('#mgrRole').text(mgr.role);
                        $('#mgrPosition').text(mgr.position || '—');
                        $('#mgrAddress').text(mgr.address || '—');
                        $('#mgrSalary').text(mgr.salary || '—');
                        $('#mgrManagerId').text(mgr.managerId || 'N/A');

                        let mgrRows = '';
                        $.each(data.managerAttendance, function (i, att) {
                            mgrRows += `<tr>
                                <td>${new Date(att.date).toLocaleDateString()}</td>
                                <td>${att.attendanceType}</td>
                            </tr>`;
                        });
                        $('#managerAttendanceTable tbody').html(mgrRows);
                        $('#managerAttendanceTable').DataTable({ destroy: true, paging: true, searching: false, info: false });

                        let teamRows = '';
                        $.each(data.teamAttendance, function (i, att) {
                            teamRows += `<tr>
                                <td>${att.employeeName}</td>
                                <td>${new Date(att.date).toLocaleDateString()}</td>
                                <td>${att.attendanceType}</td>
                            </tr>`;
                        });
                        $('#attendanceTable tbody').html(teamRows);
                        $('#attendanceTable').DataTable({ destroy: true, paging: true, searching: false, info: false });
                    } else {
                        alert(data.message);
                    }
                }
            });
        }

        function loadTeam() {
            $.ajax({
                url: '/Employee/GetTeam',
                method: 'GET',
                success: function (res) {
                    if (res.success) {
                        let rows = '';
                        $.each(res.data, function (i, emp) {
                            rows += `<tr>
                                <td>${emp.id}</td>
                                <td>${emp.name}</td>
                                <td>${emp.email}</td>
                                <td>${emp.role}</td>
                                <td><button class="btn btn-sm btn-info show-detail" data-id="${emp.id}">Details</button></td>
                            </tr>`;
                        });
                        $('#teamTable tbody').html(rows);
                        $('#teamTable').DataTable({ destroy: true, paging: true, searching: false, info: false });

                        $('.show-detail').click(function () {
                            const empId = $(this).data('id');
                            const employee = res.data.find(e => e.id === empId);
                            showEmployeeDetail(employee);
                        });
                    } else {
                        alert(res.message);
                    }
                }
            });
        }

        function showEmployeeDetail(emp) {
            $('#empImage').attr('src', emp.imagePath || '/image/default-avatar.PNG');
            $('#empName').text(emp.name);
            $('#empEmail').text(emp.email);
            $('#empRole').text(emp.role);
            $('#empPosition').text(emp.position || '—');
            $('#empAddress').text(emp.address || '—');
            $('#empSalary').text(emp.salary || '—');
                    const manager = allEmployees.find(m => m.id === emp.managerId);
        $('#empManagerId').text(manager ? manager.name : 'N/A');


            $('#employeeDetailOverlay').fadeIn();
            $('#employeeDetailCard').fadeIn();
        }
    </script>
}
